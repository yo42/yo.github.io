<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>Kubernetes 服务发现&amp;负载均衡 | Neo42 | Dont&#39;t Panic,Do not go gentle into that good night :)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Technology">
    <meta name="description" content="本文档记录，k8s如何暴露公网服务以及负载均衡 主要涉及两个知识点：k8s service、k8s ingress controller  对比传统单体垂直的架构，可以使用k8s service、k8s ingress controller 进行替代HAproxy+Nginx">
<meta name="keywords" content="Technology">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes 服务发现&amp;负载均衡">
<meta property="og:url" content="https://yo42.github.io/2019/04/25/Kubernetes-服务暴露-负载均衡/index.html">
<meta property="og:site_name" content="Neo42">
<meta property="og:description" content="本文档记录，k8s如何暴露公网服务以及负载均衡 主要涉及两个知识点：k8s service、k8s ingress controller  对比传统单体垂直的架构，可以使用k8s service、k8s ingress controller 进行替代HAproxy+Nginx">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://yo42.github.io/2019/04/25/Kubernetes-服务暴露-负载均衡/edu后端架构交互时序图.png">
<meta property="og:image" content="https://yo42.github.io/2019/04/25/Kubernetes-服务暴露-负载均衡/HTTP-Ingress.png">
<meta property="og:image" content="https://yo42.github.io/2019/04/25/Kubernetes-服务暴露-负载均衡/kubernetes-ingress-controller-and-ingresses.png">
<meta property="og:image" content="https://yo42.github.io/2019/04/25/Kubernetes-服务暴露-负载均衡/NGINX-Ingress-Controller-4-services.png">
<meta property="og:updated_time" content="2019-04-26T12:59:32.618Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kubernetes 服务发现&amp;负载均衡">
<meta name="twitter:description" content="本文档记录，k8s如何暴露公网服务以及负载均衡 主要涉及两个知识点：k8s service、k8s ingress controller  对比传统单体垂直的架构，可以使用k8s service、k8s ingress controller 进行替代HAproxy+Nginx">
<meta name="twitter:image" content="https://yo42.github.io/2019/04/25/Kubernetes-服务暴露-负载均衡/edu后端架构交互时序图.png">
    
        <link rel="alternate" type="application/atom+xml" title="Neo42" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/yo.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Neo</h5>
          <a href="mailto:edyo7024@gmail.com" title="edyo7024@gmail.com" class="mail">edyo7024@gmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                Home
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://yo42.github.io/Aobut-Me/"  >
                <i class="icon icon-lg icon-user"></i>
                About Me
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Kubernetes 服务发现&amp;负载均衡</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="Search">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Kubernetes 服务发现&amp;负载均衡</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-04-25T10:26:16.482Z" itemprop="datePublished" class="page-time">
  2019-04-25
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Technology/">Technology</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#K8s-Service"><span class="post-toc-number">1.</span> <span class="post-toc-text">K8s Service</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#集群外部访问pod或service"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">集群外部访问pod或service</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#将容器应用端口映射到物理机"><span class="post-toc-number">1.1.1.</span> <span class="post-toc-text">将容器应用端口映射到物理机</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#将Service的端口映射到物理机-type-NodePort"><span class="post-toc-number">1.1.2.</span> <span class="post-toc-text">将Service的端口映射到物理机(type=NodePort)</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#发布服务-——-服务类型"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">发布服务 —— 服务类型</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#服务发现"><span class="post-toc-number">2.</span> <span class="post-toc-text">服务发现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#环境变量"><span class="post-toc-number">2.0.1.</span> <span class="post-toc-text">环境变量</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#DNS"><span class="post-toc-number">2.0.2.</span> <span class="post-toc-text">DNS</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#创建ClusterIP类型的Service资源"><span class="post-toc-number">2.0.3.</span> <span class="post-toc-text">创建ClusterIP类型的Service资源</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#创建-NodePort类型的Service资源"><span class="post-toc-number">2.0.4.</span> <span class="post-toc-text">创建 NodePort类型的Service资源</span></a></li></ol></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#集群外部访问服务"><span class="post-toc-number"></span> <span class="post-toc-text">集群外部访问服务</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#K8s-Ingress-Controller"><span class="post-toc-number">1.</span> <span class="post-toc-text">K8s Ingress Controller</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Ingress-架构图"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">Ingress 架构图</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Ingress-Nginx实现"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">Ingress-Nginx实现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#添加外网接入的service资源"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">添加外网接入的service资源</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ingress-nginx代理http示例"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">ingress nginx代理http示例</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#配置阿里云SLB-添加nginx-ingress组-将带有nginx-ingress的node节点添加至阿里云SLB"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">配置阿里云SLB,添加nginx-ingress组,将带有nginx-ingress的node节点添加至阿里云SLB</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#traefik-ingress实现"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">traefik ingress实现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#traefik-WEB-管理页面"><span class="post-toc-number">1.4.0.1.</span> <span class="post-toc-text">traefik WEB 管理页面</span></a></li></ol></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#参考资料"><span class="post-toc-number">2.</span> <span class="post-toc-text">参考资料</span></a></li></ol>
        </nav>
    </aside>


<article id="post-Kubernetes-服务暴露-负载均衡"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Kubernetes 服务发现&负载均衡</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-04-25 18:26:16" datetime="2019-04-25T10:26:16.482Z"  itemprop="datePublished">2019-04-25</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Technology/">Technology</a></li></ul>



            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>本文档记录，k8s如何暴露公网服务以及负载均衡</p>
<p>主要涉及两个知识点：k8s service、k8s ingress controller </p>
<p>对比传统单体垂直的架构，可以使用k8s service、k8s ingress controller 进行替代HAproxy+Nginx</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="edu后端架构交互时序图.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<h2 id="K8s-Service"><a href="#K8s-Service" class="headerlink" title="K8s Service"></a>K8s Service</h2><p>基本每次创建k8s pod最好都提前定义好service对象，其实service的概念可以同等于CMDB中的服务组的概念。</p>
<p>直接通过Pod的IP地址+端口可以访问到容器应用，但是Pod的IP是动态的，当发生故障时k8s会重新调度，这时候Service服务自发现的作用就体现出来了。</p>
<p>其实这个概念和微服务非常类似。一个<code>Serivce</code>下面包含的<code>Pod</code>集合一般是由<code>Label Selector</code>来决定的。</p>
<p>要想外部可以访问创建的应用，就使用service吧。</p>
<p>我们也了解到Pod的生命是有限的，死亡过后不会复活了。我们后面学习到的RC和Deployment可以用来动态的创建和销毁Pod。尽管每个Pod都有自己的IP地址，但是如果Pod重新启动了的话那么他的IP很有可能也就变化了。这就会带来一个问题：比如我们有一些后端的Pod的集合为集群中的其他前端的Pod集合提供API服务，如果我们在前端的Pod中把所有的这些后端的Pod的地址都写死，然后去某种方式去访问其中一个Pod的服务，这样看上去是可以工作的，对吧？但是如果这个Pod挂掉了，然后重新启动起来了，是不是IP地址非常有可能就变了，这个时候前端就极大可能访问不到后端的服务了。</p>
<p>遇到这样的问题该怎么解决呢？在没有使用Kubernetes之前，我相信可能很多同学都遇到过这样的问题，不一定是IP变化的问题，比如我们在部署一个WEB服务的时候，前端一般部署一个Nginx作为服务的入口，然后Nginx后面肯定就是挂载的这个服务的大量后端，很早以前我们可能是去手动更改Nginx配置中的upstream选项，来动态改变提供服务的数量，到后面出现了一些服务发现的工具，比如Consul、ZooKeeper还有我们熟悉的etcd等工具，有了这些工具过后我们就可以只需要把我们的服务注册到这些服务发现中心去就可以，然后让这些工具动态的去更新Nginx的配置就可以了，我们完全不用去手工的操作了。</p>
<p>在k8s体系中”有三种IP”</p>
<ul>
<li>Node IP： Node节点的IP</li>
<li>Pod IP：Pod的IP</li>
<li>Cluster IP：service的IP</li>
</ul>
<p>k8s 提供两种负载分发策略，RoundRobin、SessionAffinity(默认是RoundRobin)</p>
<h3 id="集群外部访问pod或service"><a href="#集群外部访问pod或service" class="headerlink" title="集群外部访问pod或service"></a>集群外部访问pod或service</h3><h4 id="将容器应用端口映射到物理机"><a href="#将容器应用端口映射到物理机" class="headerlink" title="将容器应用端口映射到物理机"></a>将容器应用端口映射到物理机</h4><ul>
<li>通过设置容器级别的hostport</li>
<li>设置pod级别的HostNetwork=true</li>
</ul>
<h4 id="将Service的端口映射到物理机-type-NodePort"><a href="#将Service的端口映射到物理机-type-NodePort" class="headerlink" title="将Service的端口映射到物理机(type=NodePort)"></a>将Service的端口映射到物理机(type=NodePort)</h4><p>Service分类：</p>
<table>
<thead>
<tr>
<th style="text-align:left">名称</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ClusterIP</td>
<td style="text-align:left">只在集群内部可达的私网地址，集群外部无法访问</td>
</tr>
<tr>
<td style="text-align:left">NodePort</td>
<td style="text-align:left">通过节点端口映射使得集群外部可达，是在ClusterIP基础上添加一层节点端口映射，访问路径：集群外客户端–&gt;节点ip:port–&gt;ClusterIP:port–&gt;PodIP:port</td>
</tr>
<tr>
<td style="text-align:left">LoadBalancer</td>
<td style="text-align:left">如果客户端只访问一个节点，会对该节点造成很大压力，一般在NodePort之前加入负载均衡，加入负载均衡器有两种方式：一是使用公有云的LBaaS，二是自己搭建负载均衡器</td>
</tr>
<tr>
<td style="text-align:left">ExternalName</td>
<td style="text-align:left">当Pod客户端想访问集群之外的服务时，使用前几种类型Service是无法绕过集群直接访问外部服务的，使用ExternalName类型的主机名或域名映射方式可以和集群外通信</td>
</tr>
<tr>
<td style="text-align:left">HeadLess</td>
<td style="text-align:left">特殊类型Service(无头服务)，直接把服务名称映射到Pod的Ip上</td>
</tr>
</tbody>
</table>
<p>默认创建的类型是：ClusterIP</p>
<p>kubernetes网络分为三类：node network、pod network、cluster network，前两种是真实存在的，而cluster network是虚拟的，仅用于Service资源。</p>
<h3 id="发布服务-——-服务类型"><a href="#发布服务-——-服务类型" class="headerlink" title="发布服务 —— 服务类型"></a>发布服务 —— 服务类型</h3><p>对一些应用（如 Frontend）的某些部分，可能希望通过外部（Kubernetes 集群外部）IP 地址暴露 Service。</p>
<p>Kubernetes <code>ServiceTypes</code> 允许指定一个需要的类型的 Service，默认是 <code>ClusterIP</code> 类型。</p>
<p><code>Type</code> 的取值以及行为如下：</p>
<ul>
<li><code>ClusterIP</code>：通过集群的内部 IP 暴露服务，选择该值，服务只能够在集群内部可以访问，这也是默认的 <code>ServiceType</code>。</li>
<li><code>NodePort</code>：通过每个 Node 上的 IP 和静态端口（<code>NodePort</code>）暴露服务。<code>NodePort</code> 服务会路由到 <code>ClusterIP</code> 服务，这个 <code>ClusterIP</code> 服务会自动创建。通过请求 <code>&lt;NodeIP&gt;:&lt;NodePort&gt;</code>，可以从集群的外部访问一个 <code>NodePort</code> 服务。</li>
<li><code>LoadBalancer</code>：使用云提供商的负载均衡器，可以向外部暴露服务。外部的负载均衡器可以路由到 <code>NodePort</code> 服务和 <code>ClusterIP</code> 服务。</li>
<li><code>ExternalName</code>：通过返回 <code>CNAME</code> 和它的值，可以将服务映射到 <code>externalName</code> 字段的内容（例如， <code>foo.bar.example.com</code>）。 没有任何类型代理被创建，这只有 Kubernetes 1.7 或更高版本的 <code>kube-dns</code> 才支持。</li>
</ul>
<h2 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h2><p>Kubernetes 支持2种基本的服务发现模式 —— 环境变量和 DNS。</p>
<h4 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h4><p>当 <code>Pod</code> 运行在 <code>Node</code> 上，kubelet 会为每个活跃的 <code>Service</code> 添加一组环境变量。 它同时支持 <a href="https://docs.docker.com/userguide/dockerlinks/" target="_blank" rel="noopener">Docker links 兼容</a> 变量（查看 makeLinkVariables）、简单的 <code>{SVCNAME}_SERVICE_HOST</code> 和 <code>{SVCNAME}_SERVICE_PORT</code> 变量，这里 <code>Service</code> 的名称需大写，横线被转换成下划线。</p>
<p>举个例子，一个名称为 <code>&quot;redis-master&quot;</code> 的 Service 暴露了 TCP 端口 6379，同时给它分配了 Cluster IP 地址 10.0.0.11，这个 Service 生成了如下环境变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">REDIS_MASTER_SERVICE_HOST=10.0.0.11</span><br><span class="line">REDIS_MASTER_SERVICE_PORT=6379</span><br><span class="line">REDIS_MASTER_PORT=tcp://10.0.0.11:6379</span><br><span class="line">REDIS_MASTER_PORT_6379_TCP=tcp://10.0.0.11:6379</span><br><span class="line">REDIS_MASTER_PORT_6379_TCP_PROTO=tcp</span><br><span class="line">REDIS_MASTER_PORT_6379_TCP_PORT=6379</span><br><span class="line">REDIS_MASTER_PORT_6379_TCP_ADDR=10.0.0.11</span><br></pre></td></tr></table></figure>
<p><em>这意味着需要有顺序的要求</em> —— <code>Pod</code> 想要访问的任何 <code>Service</code> 必须在 <code>Pod</code> 自己之前被创建，否则这些环境变量就不会被赋值。DNS 并没有这个限制</p>
<h4 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h4><p>一个可选（尽管强烈推荐）<a href="http://releases.k8s.io/master/cluster/addons/README.md" target="_blank" rel="noopener">集群插件</a> 是 DNS 服务器。 DNS 服务器监视着创建新 <code>Service</code> 的 Kubernetes API，从而为每一个 <code>Service</code> 创建一组 DNS 记录。 如果整个集群的 DNS 一直被启用，那么所有的 <code>Pod</code>应该能够自动对 <code>Service</code> 进行名称解析。</p>
<p>例如，有一个名称为 <code>&quot;my-service&quot;</code> 的 <code>Service</code>，它在 Kubernetes 集群中名为 <code>&quot;my-ns&quot;</code> 的 <code>Namespace</code> 中，为 <code>&quot;my-service.my-ns&quot;</code> 创建了一条 DNS 记录。 在名称为 <code>&quot;my-ns&quot;</code> 的 <code>Namespace</code>中的 <code>Pod</code> 应该能够简单地通过名称查询找到 <code>&quot;my-service&quot;</code>。 在另一个 <code>Namespace</code> 中的 <code>Pod</code> 必须限定名称为 <code>&quot;my-service.my-ns&quot;</code>。 这些名称查询的结果是 Cluster IP。</p>
<p>Kubernetes 也支持对端口名称的 DNS SRV（Service）记录。 如果名称为 <code>&quot;my-service.my-ns&quot;</code> 的 <code>Service</code> 有一个名为 <code>&quot;http&quot;</code> 的 <code>TCP</code> 端口，可以对 <code>&quot;_http._tcp.my-service.my-ns&quot;</code> 执行 DNS SRV 查询，得到 <code>&quot;http&quot;</code> 的端口号。</p>
<p>Kubernetes DNS 服务器是唯一的一种能够访问 <code>ExternalName</code> 类型的 Service 的方式。 更多信息可以查看 <a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/" target="_blank" rel="noopener">DNS Pod 和 Service</a>。</p>
<h4 id="创建ClusterIP类型的Service资源"><a href="#创建ClusterIP类型的Service资源" class="headerlink" title="创建ClusterIP类型的Service资源"></a>创建ClusterIP类型的Service资源</h4><p>创建ClusterIP类型的Service资源配置文件service-clusterIP-demo.yml，这个Service资源关联使用Deployment创建的3个Pod，内容如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ---------------------- Deployment资源 ----------------------</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-dm</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面是ReplicaSet的spec</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">nginx-pod</span></span><br><span class="line">      <span class="comment"># 注意：这里标签一定要包括上面自定义的selector标签</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">        tier:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="comment"># 下面就是pod的spec</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">nginx:1.15.2</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 资源定义分割符</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------- Service资源 ----------------------</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-svc</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 这里选择器要关联到哪些Pod资源</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">nginx-ports</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看select是否匹配</span></span><br><span class="line">kubectl get deployments -o wide</span><br><span class="line">kubectl get pod --show-labels -o wide</span><br><span class="line">kubectl get service -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断是否关联成功，从获取service中得到虚拟ip地址10.106.176.161，</span></span><br><span class="line">curl 10.106.176.161</span><br><span class="line"></span><br><span class="line"><span class="comment"># service资源内置负载均衡器，每次访问都会随机访问到3个nginx服务中的一个。</span></span><br></pre></td></tr></table></figure>
<h4 id="创建-NodePort类型的Service资源"><a href="#创建-NodePort类型的Service资源" class="headerlink" title="创建 NodePort类型的Service资源"></a>创建 NodePort类型的Service资源</h4><p>NodePort类型是ClusterIp类型的增强版，是外部网络打通集群边界的一种方式。客户端访问流程：集群外的客户端 –&gt; NodeIP:NodePort –&gt; ClusterIP:servicePort –&gt; PortIP:containerPort。</p>
<p>创建NodePort类型的Service资源配置文件service-notePort-demo.yml，这个Service资源关联使用Deployment创建的3个Pod，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-svc-np</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 这里选择器要关联到哪些Pod资源</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">nginx-ports</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="comment"># 确保节点端口没被使用过，也可不指定，让系统分配随机端口</span></span><br><span class="line"><span class="attr">    nodePort:</span> <span class="number">30080</span></span><br></pre></td></tr></table></figure>
<p>测试在集群外部浏览器 http://&lt;集群节点ip&gt;:30080 是否可以访问。</p>
<h1 id="集群外部访问服务"><a href="#集群外部访问服务" class="headerlink" title="集群外部访问服务"></a>集群外部访问服务</h1><p>Service 的 ClusterIP 是 Kubernetes 内部的虚拟 IP 地址，无法直接从外部直接访问。但如果需要从外部访问这些服务该怎么办呢，有多种方法</p>
<ul>
<li>使用 NodePort 服务在每台机器上绑定一个端口，这样就可以通过 <code>&lt;NodeIP&gt;:NodePort</code> 来访问该服务。</li>
<li>使用 LoadBalancer 服务借助 Cloud Provider 创建一个外部的负载均衡器，并将请求转发到 <code>&lt;NodeIP&gt;:NodePort</code>。该方法仅适用于运行在云平台之中的 Kubernetes 集群。对于物理机部署的集群，可以使用 <a href="https://github.com/google/metallb" target="_blank" rel="noopener">MetalLB</a> 实现类似的功能。</li>
<li>使用 Ingress Controller 在 Service 之上创建 L7 负载均衡并对外开放。</li>
</ul>
<p>​    </p>
<h2 id="K8s-Ingress-Controller"><a href="#K8s-Ingress-Controller" class="headerlink" title="K8s Ingress Controller"></a>K8s Ingress Controller</h2><p>Service属于四层网络模型，是在网络协议TCP或UDP之上，而http或https属于七层网络模型，无法使用Service来解析七层的http或https，为了解决这个问题，在节点运行一个代理服务的Pod，这个Pod里的容器共享宿主机网络(host network)，外部可以直接访问，并且运行属于七层网络模型代理服务(Nginx、Traefik、Envoy)，所有的客户端的请求都先经过代理服务的Pod，代理服务Pod把请求转发给其他Pod，而且各个Pod之间是同一个网段，可以直接通信。为了解决代理服务Pod单点问题，使用DaemonSet类型的Pod控制器，DaemonSet控制的Pod会在每个node节点运行一个代理服务Pod，如果集群的节点很多的话，选择3个节点专门用来运行服务代理即可，不必每个节点都运行代理服务。</p>
<p>这种代理服务的Pod属于ingress controller，ingress controller是独立于集群master中manager controller。而ingress是集群的一种特殊资源，定义ingress资源时需要指明ingress controller的前端是虚拟主机或url映射。集群中运行很多组的pod(例如：用户、电商、社交、交易、物流等)，ingress controller怎么知道哪些请求是指向哪组Pod？可以使用虚拟主机或url映射(/usr/、/shop/等)，因为Pod是有生命周期的，Pod的Ip地址有可能随时改变，ingress controller经过url映射的Pod就保证存在呢？解决方法是借助headless ClusterIp类型的Service资源，Service不是用来代理，只用来对Pod进行分组，ingress实时监控Service中Pod的ip地址是否变化，如果有变化，ingress实时获取到变化后Pod的ip信息，然后注入到ingress controller的配置文件中，并触发ingress controller中容器进程重载配置文件。</p>
<p>而ingress controller目前有几种：</p>
<ul>
<li>k8s社区提供的ingress</li>
<li>nginx社区提供的ingress</li>
<li>Traefik</li>
<li>…</li>
</ul>
<p>k8s-nginx-ingress 、nginxC-ingress两者之间的区别</p>
<p><a href="https://github.com/nginxinc/kubernetes-ingress/blob/master/docs/nginx-ingress-controllers.md" target="_blank" rel="noopener">https://github.com/nginxinc/kubernetes-ingress/blob/master/docs/nginx-ingress-controllers.md</a></p>
<h3 id="Ingress-架构图"><a href="#Ingress-架构图" class="headerlink" title="Ingress 架构图"></a>Ingress 架构图</h3><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="HTTP-Ingress.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="kubernetes-ingress-controller-and-ingresses.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="NGINX-Ingress-Controller-4-services.png" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<h3 id="Ingress-Nginx实现"><a href="#Ingress-Nginx实现" class="headerlink" title="Ingress-Nginx实现"></a>Ingress-Nginx实现</h3><p>参考文档:</p>
<p><a href="https://kubernetes.github.io/ingress-nginx/deploy/" target="_blank" rel="noopener">https://kubernetes.github.io/ingress-nginx/deploy/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f /etc/ansible/manifests/ingress/nginx-ingress/nginx-ingress.yaml <span class="comment"># 创建ingress</span></span><br><span class="line">kubectl create -f /etc/ansible/manifests/ingress/nginx-ingress/nginx-ingress-svc.yaml <span class="comment"># 创建ingress-svc</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看ingress-nginx各类资源列表</span></span><br><span class="line">kubectl get ns | grep ingress-nginx</span><br><span class="line">kubectl get cm -n ingress-nginx</span><br><span class="line">kubectl get deployment -n ingress-nginx</span><br><span class="line">kubectl get pod -n ingress-nginx</span><br></pre></td></tr></table></figure>
<h4 id="添加外网接入的service资源"><a href="#添加外网接入的service资源" class="headerlink" title="添加外网接入的service资源"></a>添加外网接入的service资源</h4><p>在本地测试为了接入集群外的请求，需要另外创建一个NodePort类型service做转发，如果是在公有云部署的集群，建议使用LoadBalancer类型service，参考<a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/provider/cloud-generic.yaml" target="_blank" rel="noopener">service</a>。</p>
<p>创建NodePort类型的service资源配置文件ingress-nginx-serivce.yml，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">YAMLapiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="string">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line">    <span class="string">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="string">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="comment"># 指定宿主机端口</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">30080</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">443</span></span><br><span class="line">      <span class="comment"># 指定宿主机端口</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">30443</span></span><br></pre></td></tr></table></figure>
<p>查看调度器nginx ingress controller是否工作正常：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BASH<span class="comment"># 所有从集群外进来的http使用30080，https使用30443</span></span><br><span class="line">curl mater:30080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果返回default backend - 404，说明调度器已经正常工作了，只是没有后端而已</span></span><br></pre></td></tr></table></figure>
<h4 id="ingress-nginx代理http示例"><a href="#ingress-nginx代理http示例" class="headerlink" title="ingress nginx代理http示例"></a>ingress nginx代理http示例</h4><p>开始部署app，创建headless类型的service资源和Deployment资源配置文件myapp-service-deployment.yml，其中service资源只用来对Deployment的Pod进行分组的，获取到Pod的ip给ingress资源使用，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">YAMLapiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">myapp-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">  clusterIP:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">myapp-dm</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">ikubernetes/myapp:v3</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>创建ingress资源配置文件http-myapp-ingress.yml，ingress会监听service服务myapp-svc，一旦发现myapp-svc发生改变，ingress会从myapp-svc获取最新的Pod信息，把最新配置信息注入到nginx配置信息。内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">YAMLapiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="comment"># 声明使用类型：nginx、traefik、envoy，让ingress controller匹配对应的规则</span></span><br><span class="line">    <span class="string">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line">  <span class="comment"># 这里使用虚拟主机，也可以使用url映射</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">demo.myapp.com</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - path:</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">myapp-svc</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>测试ingress是否能够动态注入nginx.conf，并触发nginx重载配置信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">BASH<span class="comment"># 获取ingress nginx的pod名称</span></span><br><span class="line">kubectl get pod -n ingress-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入容器</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it -n ingress-nginx nginx-ingress-controller-6bd7c597cb-tf7gx -- /bin/sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看nginx配置是否包含虚拟主机demo.myapp.com配置信息，Deployment类型资源myapp-dm下的pod的ip列表是否也存在</span></span><br><span class="line">cat nginx.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果后端的Pod挂掉了，Pod的ip地址变化会被ingress通过service检测到，ingress把变化的信息重新注入到nginx配置文件中。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在节点宿主机添加测试域名demo.myapp.com</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'192.168.8.90  demo.myapp.com'</span> &gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在一个终端不断获取myapp名称，查看删除pod后获取的名称是否有更新</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> curl demo.myapp.com:30080/hostname.html; sleep 1;<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取pod</span></span><br><span class="line">kubectl get pod</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除两个pod</span></span><br><span class="line">kubectl delete pod myapp-dm-59f7c855f7-5tmhw myapp-dm-59f7c855f7-5v6zw</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从结果上看，pod后获取的名称是更新的，说明ingress能把最新pod的信息动态注入nginx配置中，并触发nginx服务重载配置。</span></span><br></pre></td></tr></table></figure>
<p>创建成功后，Ingress会将信息注入到ingress-controller里面去，即：会自动转换为nginx的配置文件,可以看到pod内的nginx.conf文件确实被注入了myapp相关的信息。此时，在本地机器绑定myapp.test.com为两个node的ip，就可以在本地机器的浏览器中访问 <a href="http://myapp.test.com:30080/" target="_blank" rel="noopener">http://myapp.test.com:30080/</a> 网页了。</p>
<h3 id="配置阿里云SLB-添加nginx-ingress组-将带有nginx-ingress的node节点添加至阿里云SLB"><a href="#配置阿里云SLB-添加nginx-ingress组-将带有nginx-ingress的node节点添加至阿里云SLB" class="headerlink" title="配置阿里云SLB,添加nginx-ingress组,将带有nginx-ingress的node节点添加至阿里云SLB"></a>配置阿里云SLB,添加nginx-ingress组,将带有nginx-ingress的node节点添加至阿里云SLB</h3><h3 id="traefik-ingress实现"><a href="#traefik-ingress实现" class="headerlink" title="traefik ingress实现"></a>traefik ingress实现</h3><p>部署 traefik ingress-controller</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f /etc/ansible/manifests/ingress/traefik/traefik-ingress.yaml</span><br></pre></td></tr></table></figure>
<p>验证 traefik ingress-controller</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get deploy -n kube-system traefik-ingress-controller</span></span><br><span class="line">NAME                         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">traefik-ingress-controller   1         1         1            1           4m</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get svc -n kube-system traefik-ingress-service</span></span><br><span class="line">NAME                      TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                       AGE</span><br><span class="line">traefik-ingress-service   NodePort   10.68.69.170   &lt;none&gt;        80:23456/TCP,8080:34815/TCP   4m</span><br><span class="line">可以看到traefik-ingress-service 服务端口80暴露的nodePort确实为23456</span><br></pre></td></tr></table></figure>
<p>测试ingress</p>
<p>首先创建测试用K8S应用，并且该应用服务不用nodePort暴露，而是用ingress方式让外部访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl run <span class="built_in">test</span>-hello --image=nginx --expose --port=80</span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># kubectl get deploy test-hello</span></span><br><span class="line">NAME         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line"><span class="built_in">test</span>-hello   1         1         1            1           56s</span><br><span class="line"><span class="comment"># kubectl get svc test-hello</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line"><span class="built_in">test</span>-hello   ClusterIP   10.68.124.115   &lt;none&gt;        80/TCP    1m</span><br></pre></td></tr></table></figure>
<p>然后为这个应用创建 ingress对象</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="bullet">-f</span> <span class="string">/etc/ansible/manifests/ingress/test-hello.ing.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># test-hello.ing.yaml内容</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-hello</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">hello.test.com</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">test-hello</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>集群内部尝试访问: curl -H Host:hello.test.com 10.68.69.170(traefik-ingress-service的服务地址) 能够看到欢迎页面 Welcome to nginx!；</p>
<p>在集群外部尝试访问(假定集群一个NodeIP为 192.168.1.1): curl -H Host:hello.test.com 192.168.1.1:23456，也能够看到欢迎页面 Welcome to nginx!，说明ingress测试成功</p>
<h5 id="traefik-WEB-管理页面"><a href="#traefik-WEB-管理页面" class="headerlink" title="traefik WEB 管理页面"></a>traefik WEB 管理页面</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># traefik-ui.ing.yaml内容</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">traefik-web-ui</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">traefik-ui.test.com</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">traefik-ingress-service</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><blockquote>
<ul>
<li><a href="https://www.qikqiak.com/post/use-service-in-k8s/" target="_blank" rel="noopener"><a href="https://www.qikqiak.com/post/use-service-in-k8s/" target="_blank" rel="noopener">https://www.qikqiak.com/post/use-service-in-k8s/</a></a></li>
<li><a href="https://zhuyasen.com/post/k8s.html#toc_28" target="_blank" rel="noopener"><a href="https://zhuyasen.com/post/k8s.html#toc_28" target="_blank" rel="noopener">https://zhuyasen.com/post/k8s.html#toc_28</a></a></li>
<li><a href="https://jimmysong.io/kubernetes-handbook/concepts/service.html" target="_blank" rel="noopener"><a href="https://jimmysong.io/kubernetes-handbook/concepts/service.html" target="_blank" rel="noopener">https://jimmysong.io/kubernetes-handbook/concepts/service.html</a></a></li>
<li><a href="https://yq.aliyun.com/articles/603225" target="_blank" rel="noopener"><a href="https://yq.aliyun.com/articles/603225" target="_blank" rel="noopener">https://yq.aliyun.com/articles/603225</a></a></li>
<li><a href="https://yq.aliyun.com/articles/604570?spm=a2c4e.11153940.blogcont603225.37.2d83f94cpAHZAL" target="_blank" rel="noopener"><a href="https://yq.aliyun.com/articles/604570?spm=a2c4e.11153940.blogcont603225.37.2d83f94cpAHZAL" target="_blank" rel="noopener">https://yq.aliyun.com/articles/604570?spm=a2c4e.11153940.blogcont603225.37.2d83f94cpAHZAL</a></a></li>
</ul>
</blockquote>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2019-04-26T12:59:32.618Z" itemprop="dateUpdated">2019-04-26 20:59:32</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="https://yo42.github.io">
            <img src="/img/yo.jpg" alt="Neo">
            Neo
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Technology/">Technology</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://yo42.github.io/2019/04/25/Kubernetes-服务暴露-负载均衡/&title=《Kubernetes 服务发现&负载均衡》 — Neo42&pic=https://yo42.github.io/img/yo.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://yo42.github.io/2019/04/25/Kubernetes-服务暴露-负载均衡/&title=《Kubernetes 服务发现&负载均衡》 — Neo42&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://yo42.github.io/2019/04/25/Kubernetes-服务暴露-负载均衡/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Kubernetes 服务发现&负载均衡》 — Neo42&url=https://yo42.github.io/2019/04/25/Kubernetes-服务暴露-负载均衡/&via=https://yo42.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://yo42.github.io/2019/04/25/Kubernetes-服务暴露-负载均衡/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2019/04/25/Kubernetes-Deployment/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Kubernetes Deployment</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2019/04/24/Kubernetes-实践-基础概念总结/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Kubernetes 实践&amp;基础概念总结</h4>
      </a>
    </div>
  
</nav>



    

















</article>



</div>

        <footer class="footer">
    <div class="top">
        

        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>This blog is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Neo &copy; 2019</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> 
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://yo42.github.io/2019/04/25/Kubernetes-服务暴露-负载均衡/&title=《Kubernetes 服务发现&负载均衡》 — Neo42&pic=https://yo42.github.io/img/yo.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://yo42.github.io/2019/04/25/Kubernetes-服务暴露-负载均衡/&title=《Kubernetes 服务发现&负载均衡》 — Neo42&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://yo42.github.io/2019/04/25/Kubernetes-服务暴露-负载均衡/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Kubernetes 服务发现&负载均衡》 — Neo42&url=https://yo42.github.io/2019/04/25/Kubernetes-服务暴露-负载均衡/&via=https://yo42.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://yo42.github.io/2019/04/25/Kubernetes-服务暴露-负载均衡/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://yo42.github.io/2019/04/25/Kubernetes-服务暴露-负载均衡/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>










<script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>