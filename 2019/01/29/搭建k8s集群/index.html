<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>搭建k8s集群 | Yo42 | Dont&#39;t Panic,Do not go gentle into that good night~</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="">
    <meta name="description" content="集群节点 初始化1略 集群环境变量&amp;amp;节点分发12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455# TLS Bootstrapping 使用的Token，可以使用命令 head -c 16 /dev/urandom | od -An -t x">
<meta name="keywords" content="DevOps">
<meta property="og:type" content="article">
<meta property="og:title" content="搭建k8s集群">
<meta property="og:url" content="https://yo42.github.io/2019/01/29/搭建k8s集群/index.html">
<meta property="og:site_name" content="Yo42">
<meta property="og:description" content="集群节点 初始化1略 集群环境变量&amp;amp;节点分发12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455# TLS Bootstrapping 使用的Token，可以使用命令 head -c 16 /dev/urandom | od -An -t x">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-02-12T10:57:34.004Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="搭建k8s集群">
<meta name="twitter:description" content="集群节点 初始化1略 集群环境变量&amp;amp;节点分发12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455# TLS Bootstrapping 使用的Token，可以使用命令 head -c 16 /dev/urandom | od -An -t x">
    
        <link rel="alternate" type="application/atom+xml" title="Yo42" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/yo.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Yo</h5>
          <a href="mailto:edyo7024@gmail.com" title="edyo7024@gmail.com" class="mail">edyo7024@gmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                Home
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://yo42.github.io/Aobut-Me/"  >
                <i class="icon icon-lg icon-user"></i>
                About Me
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">搭建k8s集群</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="Search">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">搭建k8s集群</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-01-29T02:34:08.394Z" itemprop="datePublished" class="page-time">
  2019-01-29
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#集群节点-初始化"><span class="post-toc-number">1.</span> <span class="post-toc-text">集群节点 初始化</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#集群环境变量-amp-节点分发"><span class="post-toc-number">2.</span> <span class="post-toc-text">集群环境变量&amp;节点分发</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#创建CA证书和密钥-amp-节点分发"><span class="post-toc-number">3.</span> <span class="post-toc-text">创建CA证书和密钥&amp;节点分发</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#安装CFSSL工具集"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">安装CFSSL工具集</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#生成CA-证书和私钥："><span class="post-toc-number">3.2.</span> <span class="post-toc-text">生成CA 证书和私钥：</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#部署etcd集群-节点x3"><span class="post-toc-number">4.</span> <span class="post-toc-text">部署etcd集群 (节点x3)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#创建TLS-密钥和证书"><span class="post-toc-number">5.</span> <span class="post-toc-text">创建TLS 密钥和证书</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#创建etcd-的systemd-unit-文件"><span class="post-toc-number">6.</span> <span class="post-toc-text">创建etcd 的systemd unit 文件</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#启动etcd-服务"><span class="post-toc-number">7.</span> <span class="post-toc-text">启动etcd 服务</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#验证服务"><span class="post-toc-number">7.1.</span> <span class="post-toc-text">验证服务</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#配置kubectl-命令行工具"><span class="post-toc-number">7.2.</span> <span class="post-toc-text">配置kubectl 命令行工具</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#创建admin-证书"><span class="post-toc-number">7.3.</span> <span class="post-toc-text">创建admin 证书</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#创建kubectl-kubeconfig-文件"><span class="post-toc-number">7.4.</span> <span class="post-toc-text">创建kubectl kubeconfig 文件</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#分发kubeconfig-文件"><span class="post-toc-number">7.5.</span> <span class="post-toc-text">分发kubeconfig 文件</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#部署K8s-Master节点"><span class="post-toc-number">8.</span> <span class="post-toc-text">部署K8s Master节点</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#创建kubernetes-证书"><span class="post-toc-number">8.1.</span> <span class="post-toc-text">创建kubernetes 证书</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#生成kubernetes-证书和私钥："><span class="post-toc-number">8.2.</span> <span class="post-toc-text">生成kubernetes 证书和私钥：</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#配置和启动kube-apiserver"><span class="post-toc-number">8.3.</span> <span class="post-toc-text">配置和启动kube-apiserver</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#创建kube-apiserver-使用的客户端token-文件"><span class="post-toc-number">8.4.</span> <span class="post-toc-text">创建kube-apiserver 使用的客户端token 文件</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#创建kube-apiserver-的systemd-unit文件"><span class="post-toc-number">8.5.</span> <span class="post-toc-text">创建kube-apiserver 的systemd unit文件</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#启动kube-apiserver"><span class="post-toc-number">8.6.</span> <span class="post-toc-text">启动kube-apiserver</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#配置和启动kube-controller-manager"><span class="post-toc-number">8.7.</span> <span class="post-toc-text">配置和启动kube-controller-manager</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#启动kube-controller-manager"><span class="post-toc-number">8.8.</span> <span class="post-toc-text">启动kube-controller-manager</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#配置和启动kube-scheduler"><span class="post-toc-number">8.9.</span> <span class="post-toc-text">配置和启动kube-scheduler</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#创建kube-scheduler-的systemd-unit文件"><span class="post-toc-number">8.10.</span> <span class="post-toc-text">创建kube-scheduler 的systemd unit文件</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#启动kube-scheduler"><span class="post-toc-number">9.</span> <span class="post-toc-text">启动kube-scheduler</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#6-4-验证master-节点"><span class="post-toc-number"></span> <span class="post-toc-text">6.4 验证master 节点</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#关于k8s-master节点高可用"><span class="post-toc-number">1.</span> <span class="post-toc-text">关于k8s master节点高可用</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#方式1：使用阿里云SLB"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">方式1：使用阿里云SLB</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#方式2：使用keepalived"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">方式2：使用keepalived</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#k8s-Node节点安装flannel网络"><span class="post-toc-number">2.</span> <span class="post-toc-text">k8s Node节点安装flannel网络</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#创建TLS-密钥和证书-1"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">创建TLS 密钥和证书</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#向etcd-写入集群Pod-网段信息"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">向etcd 写入集群Pod 网段信息</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#启动flanneld"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">启动flanneld</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#检查flanneld-服务"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">检查flanneld 服务</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#检查分配给各flanneld-的Pod-网段信息"><span class="post-toc-number">2.5.</span> <span class="post-toc-text">检查分配给各flanneld 的Pod 网段信息</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#部署-K8s-Node节点"><span class="post-toc-number">3.</span> <span class="post-toc-text">部署 K8s Node节点</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#解决从k8s-gcr-io拉取镜像失败问题"><span class="post-toc-number">4.</span> <span class="post-toc-text">解决从k8s.gcr.io拉取镜像失败问题</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#参考资料"><span class="post-toc-number"></span> <span class="post-toc-text">参考资料</span></a>
        </nav>
    </aside>


<article id="post-搭建k8s集群"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">搭建k8s集群</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-01-29 10:34:08" datetime="2019-01-29T02:34:08.394Z"  itemprop="datePublished">2019-01-29</time>

            


            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h3 id="集群节点-初始化"><a href="#集群节点-初始化" class="headerlink" title="集群节点 初始化"></a>集群节点 初始化</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">略</span><br></pre></td></tr></table></figure>
<h3 id="集群环境变量-amp-节点分发"><a href="#集群环境变量-amp-节点分发" class="headerlink" title="集群环境变量&amp;节点分发"></a>集群环境变量&amp;节点分发</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"># TLS Bootstrapping 使用的Token，可以使用命令 head -c 16 /dev/urandom | od -An -t x | tr -d &apos; &apos; 生成</span><br><span class="line">BOOTSTRAP_TOKEN=&quot;a4b521597f9938eaf36a82177c7c6f3a&quot;</span><br><span class="line"></span><br><span class="line"># 最好使用 当前未用的网段 来定义服务网段和 Pod 网段</span><br><span class="line"></span><br><span class="line"># 服务网段，部署前路由不可达，部署后集群内路由可达(kube-proxy 和 ipvs 保证)</span><br><span class="line">export SERVICE_CIDR=&quot;10.100.0.0/16&quot;</span><br><span class="line"></span><br><span class="line"># Pod 网段，建议 /16 段地址，部署前路由不可达，部署后集群内路由可达(flanneld 保证)</span><br><span class="line">export CLUSTER_CIDR=&quot;10.200.0.0/16&quot;</span><br><span class="line"></span><br><span class="line"># 服务端口范围 (NodePort Range)</span><br><span class="line">export NODE_PORT_RANGE=&quot;30000-32766&quot;</span><br><span class="line"></span><br><span class="line"># 集群各机器 IP 数组</span><br><span class="line">export NODE_IPS=&quot;10.1.2.30 10.1.2.1 10.1.2.2&quot;</span><br><span class="line">export NODE_IP=&quot;10.1.2.30&quot;</span><br><span class="line"></span><br><span class="line"># 集群各 IP 对应的 主机名数组</span><br><span class="line">export NODE_NAME=kube-master1</span><br><span class="line"></span><br><span class="line"># kube-apiserver 的 VIP（HA 组件 keepalived 发布的 IP）</span><br><span class="line">#export MASTER_VIP=172.27.129.253</span><br><span class="line"># MASTER API Server 地址</span><br><span class="line">MASTER_URL=&quot;hhht-k8s-api.virtual.local&quot;</span><br><span class="line"></span><br><span class="line"># kube-apiserver VIP 地址（HA 组件 haproxy 监听 8443 端口）</span><br><span class="line">export KUBE_APISERVER=&quot;https://$&#123;MASTER_URL&#125;:6443&quot;</span><br><span class="line"></span><br><span class="line"># HA 节点，配置 VIP 的网络接口名称</span><br><span class="line">#export VIP_IF=&quot;eth0&quot;</span><br><span class="line"></span><br><span class="line"># etcd 集群服务地址列表</span><br><span class="line">export ETCD_ENDPOINTS=&quot;https://10.1.2.30:2379,https://10.1.2.1:2379,https://10.1.2.2:2379&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># etcd 集群间通信的 IP 和端口</span><br><span class="line">export ETCD_NODES=&quot;kube-master1=https://10.1.2.30:2380,kube-master2=https://10.1.2.1:2380,kube-master3=https://10.1.2.2:2380&quot;</span><br><span class="line"></span><br><span class="line"># flanneld 网络配置前缀</span><br><span class="line">export FLANNEL_ETCD_PREFIX=&quot;/kubernetes/network&quot;</span><br><span class="line"></span><br><span class="line"># kubernetes 服务IP(预先分配，一般为SERVICE_CIDR中的第一个IP)</span><br><span class="line">export CLUSTER_KUBERNETES_SVC_IP=&quot;10.100.0.1&quot;</span><br><span class="line"></span><br><span class="line"># 集群 DNS 服务IP(从SERVICE_CIDR 中预先分配)</span><br><span class="line">export CLUSTER_DNS_SVC_IP=&quot;10.100.0.2&quot;</span><br><span class="line"></span><br><span class="line"># 集群 DNS 域名</span><br><span class="line">export CLUSTER_DNS_DOMAIN=&quot;hhhtcluster.local.&quot;</span><br><span class="line"></span><br><span class="line"># 将二进制目录 /opt/k8s/bin 加到 PATH 中</span><br><span class="line">PATH=/usr/k8s/bin:$PATH</span><br><span class="line"></span><br><span class="line">PATH=/apps/svr/k8s/bin:$PATH</span><br></pre></td></tr></table></figure>
<p>复制到所有服务器上给以上文件执行权限然后修改系统变量</p>
<p>echo ‘source /apps/sh/env.sh’ &gt;&gt; ~/.bash_profile</p>
<p>将上面变量保存为: env.sh，然后将脚本拷贝到所有机器的/apps/sh/目录。</p>
<p>为方便后面迁移，我们在集群内定义一个域名用于访问apiserver，在每个节点的/etc/hosts文件中添加记录：10.1.2.30 hhht-k8s-api.virtual.local</p>
<p>其中10.1.2.30为master01 的IP，暂时使用该IP 来做apiserver 的负载地址</p>
<h3 id="创建CA证书和密钥-amp-节点分发"><a href="#创建CA证书和密钥-amp-节点分发" class="headerlink" title="创建CA证书和密钥&amp;节点分发"></a>创建CA证书和密钥&amp;节点分发</h3><h4 id="安装CFSSL工具集"><a href="#安装CFSSL工具集" class="headerlink" title="安装CFSSL工具集"></a>安装CFSSL工具集</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">chmod +x cfssl_linux-amd64</span><br><span class="line">mv cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line"></span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">chmod +x cfssljson_linux-amd64</span><br><span class="line">mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line"></span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line">chmod +x cfssl-certinfo_linux-amd64</span><br><span class="line">mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo</span><br><span class="line"></span><br><span class="line">export PATH=/usr/local/bin:$PATH</span><br></pre></td></tr></table></figure>
<p>创建目录 mkdir -p /apps/conf/kubernetes/ssl</p>
<p>进入/apps/conf/kubernetes/ssl 目录新建以下2个文件</p>
<p>ca-config.json、ca-csr.json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;signing&quot;: &#123;</span><br><span class="line">        &quot;default&quot;: &#123;</span><br><span class="line">            &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;profiles&quot;: &#123;</span><br><span class="line">            &quot;kubernetes&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;87600h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>config.json</code>：可以定义多个profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个profile；</li>
<li><code>signing</code>: 表示该证书可用于签名其它证书；生成的ca.pem 证书中<code>CA=TRUE</code>；</li>
<li><code>server auth</code>: 表示client 可以用该CA 对server 提供的证书进行校验；</li>
<li><code>client auth</code>: 表示server 可以用该CA 对client 提供的证书进行验证。</li>
</ul>
<p>ca-csr.json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>CN</code>: <code>Common Name</code>，kube-apiserver 从证书中提取该字段作为请求的用户名(User Name)；浏览器使用该字段验证网站是否合法；</li>
<li><code>O</code>: <code>Organization</code>，kube-apiserver 从证书中提取该字段作为请求用户所属的组(Group)；</li>
</ul>
<h4 id="生成CA-证书和私钥："><a href="#生成CA-证书和私钥：" class="headerlink" title="生成CA 证书和私钥："></a>生成CA 证书和私钥：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class="line">ls` `ca*</span><br><span class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</span><br></pre></td></tr></table></figure>
<p>创建完成后把/apps/conf/kubernetes/ssl这个目录复制到所有master节点上</p>
<h3 id="部署etcd集群-节点x3"><a href="#部署etcd集群-节点x3" class="headerlink" title="部署etcd集群 (节点x3)"></a>部署etcd集群 (节点x3)</h3><p>kubernetes 系统使用etcd存储所有的数据，我们这里部署3个节点的etcd 集群，这3个节点直接复用kubernetes master的3个节点，分别命名为etcd01、etcd02、etcd03:</p>
<p>etcd01：10.1.2.30<br>etcd02：10.1.2.1<br>etcd03：10.1.2.2</p>
<p>修改3台master服务器的/apps/sh/env.sh文件的第31行左右</p>
<p>把以下内容修改为本机信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">####OTHER</span><br><span class="line">NODE_NAME=etcd01</span><br><span class="line">NODE_IP=10.1.2.30</span><br></pre></td></tr></table></figure>
<p>名字可以任意只要能区分就可以</p>
<p>IP填写本机IP</p>
<p>修改以下配置填入所有正确的ETCD地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`NODE_IPS=``&quot;172.18.49.242 172.18.49.243 172.18.49.244&quot;``ETCD_NODES=etcd01=https:``//172``.18.49.242:2380,etcd02=https:``//172``.18.49.243:2380,etcd03=https:``//172``.18.49.244:2380``KUBE_APISERVER=``&quot;https://$&#123;MASTER_URL&#125;:6443&quot;`</span><br></pre></td></tr></table></figure>
<p>修改完毕后执行 source /apps/sh/env.sh 命令</p>
<p>echo $NODE_NAME</p>
<p>echo $NODE_IP</p>
<p>echo $ETCD_NODES</p>
<p>输出内容是你修改的内容即正确。</p>
<h3 id="创建TLS-密钥和证书"><a href="#创建TLS-密钥和证书" class="headerlink" title="创建TLS 密钥和证书"></a>创建TLS 密钥和证书</h3><p>为了保证通信安全，客户端(如etcdctl)与etcd 集群、etcd 集群之间的通信需要使用TLS 加密。</p>
<p>创建etcd 证书签名请求：</p>
<p>对应路径：/apps/conf/etcd/ssl</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`cat` `&gt; etcd-csr.json &lt;&lt;EOF``&#123;``  ``&quot;CN&quot;``: ``&quot;etcd&quot;``,``  ``&quot;hosts&quot;``: [``    ``&quot;127.0.0.1&quot;``,``    ``&quot;$&#123;NODE_IP&#125;&quot;``  ``],``  ``&quot;key&quot;``: &#123;``    ``&quot;algo&quot;``: ``&quot;rsa&quot;``,``    ``&quot;size&quot;``: 2048``  ``&#125;,``  ``&quot;names&quot;``: [``    ``&#123;``      ``&quot;C&quot;``: ``&quot;CN&quot;``,``      ``&quot;ST&quot;``: ``&quot;BeiJing&quot;``,``      ``&quot;L&quot;``: ``&quot;BeiJing&quot;``,``      ``&quot;O&quot;``: ``&quot;k8s&quot;``,``      ``&quot;OU&quot;``: ``&quot;System&quot;``    ``&#125;``  ``]``&#125;``EOF`</span><br></pre></td></tr></table></figure>
<p>生成证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`cfssl gencert -ca=``/apps/conf/kubernetes/ssl/ca``.pem   -ca-key=``/apps/conf/kubernetes/ssl/ca-key``.pem   -config=``/apps/conf/kubernetes/ssl/ca-config``.json   -profile=kubernetes etcd-csr.json | cfssljson -bare etcd`</span><br></pre></td></tr></table></figure>
<h3 id="创建etcd-的systemd-unit-文件"><a href="#创建etcd-的systemd-unit-文件" class="headerlink" title="创建etcd 的systemd unit 文件"></a>创建etcd 的systemd unit 文件</h3><p>需要新建目录 /apps/lib/etcd/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`cat` `&gt; etcd.service &lt;&lt;EOF``[Unit]``Description=Etcd Server``After=network.target``After=network-online.target``Wants=network-online.target``Documentation=https:``//github``.com``/coreos``[Service]``Type=notify``WorkingDirectory=``/apps/lib/etcd/``ExecStart=``/apps/svr/k8s/bin/etcd` `\\``  ``--name=$&#123;NODE_NAME&#125; \\``  ``--cert-``file``=``/apps/conf/etcd/ssl/etcd``.pem \\``  ``--key-``file``=``/apps/conf/etcd/ssl/etcd-key``.pem \\``  ``--peer-cert-``file``=``/apps/conf/etcd/ssl/etcd``.pem \\``  ``--peer-key-``file``=``/apps/conf/etcd/ssl/etcd-key``.pem \\``  ``--trusted-ca-``file``=``/apps/conf/kubernetes/ssl/ca``.pem \\``  ``--peer-trusted-ca-``file``=``/apps/conf/kubernetes/ssl/ca``.pem \\``  ``--initial-advertise-peer-urls=https:``//``$&#123;NODE_IP&#125;:2380 \\``  ``--listen-peer-urls=https:``//``$&#123;NODE_IP&#125;:2380 \\``  ``--listen-client-urls=https:``//``$&#123;NODE_IP&#125;:2379,http:``//127``.0.0.1:2379 \\``  ``--advertise-client-urls=https:``//``$&#123;NODE_IP&#125;:2379 \\``  ``--initial-cluster-token=etcd-cluster-0 \\``  ``--initial-cluster=$&#123;ETCD_NODES&#125; \\``  ``--initial-cluster-state=new \\``  ``--data-``dir``=``/apps/lib/etcd``Restart=on-failure``RestartSec=5``LimitNOFILE=65536``[Install]``WantedBy=multi-user.target``EOF`</span><br></pre></td></tr></table></figure>
<ul>
<li>指定<code>etcd</code>的工作目录和数据目录为 /apps/lib/etcd/，需要在启动服务前创建这个目录；</li>
<li>为了保证通信安全，需要指定etcd 的公私钥(cert-file和key-file)、Peers通信的公私钥和CA 证书(peer-cert-file、peer-key-file、peer-trusted-ca-file)、客户端的CA 证书(trusted-ca-file)；</li>
<li><code>--initial-cluster-state</code>值为<code>new</code>时，<code>--name</code>的参数值必须位于<code>--initial-cluster</code>列表中；</li>
</ul>
<h3 id="启动etcd-服务"><a href="#启动etcd-服务" class="headerlink" title="启动etcd 服务"></a>启动etcd 服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cp etcd.service /etc/systemd/system/</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable etcd</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl status etcd</span><br></pre></td></tr></table></figure>
<p>最先启动的etcd 进程会卡住一段时间，等待其他节点启动加入集群，在所有的etcd 节点重复上面的步骤，直到所有的机器etcd 服务都已经启动。</p>
<h4 id="验证服务"><a href="#验证服务" class="headerlink" title="验证服务"></a>验证服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`for` `ip ``in` `$&#123;NODE_IPS&#125;; ``do``  ``ETCDCTL_API=3 ``/apps/svr/k8s/bin/etcdctl` `\``  ``--endpoints=https:``//``$&#123;ip&#125;:2379  \``  ``--cacert=``/apps/conf/kubernetes/ssl/ca``.pem \``  ``--cert=``/apps/conf/etcd/ssl/etcd``.pem \``  ``--key=``/apps/conf/etcd/ssl/etcd-key``.pem \``  ``endpoint health; ``done`</span><br></pre></td></tr></table></figure>
<p><a href="https://10.1.2.30:2379" target="_blank" rel="noopener">https://10.1.2.30:2379</a> is healthy: successfully committed proposal: took = 2.436477ms<br><a href="https://10.1.2.1:2379" target="_blank" rel="noopener">https://10.1.2.1:2379</a> is healthy: successfully committed proposal: took = 2.893396ms<br><a href="https://10.1.2.2:2379" target="_blank" rel="noopener">https://10.1.2.2:2379</a> is healthy: successfully committed proposal: took = 2.621429ms</p>
<h4 id="配置kubectl-命令行工具"><a href="#配置kubectl-命令行工具" class="headerlink" title="配置kubectl 命令行工具"></a>配置kubectl 命令行工具</h4><p>在master服务器上安装</p>
<p>kubectl默认从~/.kube/config配置文件中获取访问kube-apiserver 地址、证书、用户名等信息，需要正确配置该文件才能正常使用kubectl命令。</p>
<p>需要将下载的kubectl 二进制文件和生产的~/.kube/config配置文件拷贝到需要使用kubectl 命令的机器上。</p>
<h4 id="创建admin-证书"><a href="#创建admin-证书" class="headerlink" title="创建admin 证书"></a>创建admin 证书</h4><p>kubectl 与kube-apiserver 的安全端口通信，需要为安全通信提供TLS 证书和密钥。创建admin 证书签名请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`cat` `&gt; admin-csr.json &lt;&lt;EOF``&#123;``  ``&quot;CN&quot;``: ``&quot;admin&quot;``,``  ``&quot;hosts&quot;``: [],``  ``&quot;key&quot;``: &#123;``    ``&quot;algo&quot;``: ``&quot;rsa&quot;``,``    ``&quot;size&quot;``: 2048``  ``&#125;,``  ``&quot;names&quot;``: [``    ``&#123;``      ``&quot;C&quot;``: ``&quot;CN&quot;``,``      ``&quot;ST&quot;``: ``&quot;BeiJing&quot;``,``      ``&quot;L&quot;``: ``&quot;BeiJing&quot;``,``      ``&quot;O&quot;``: ``&quot;system:masters&quot;``,``      ``&quot;OU&quot;``: ``&quot;System&quot;``    ``&#125;``  ``]``&#125;``EOF`</span><br></pre></td></tr></table></figure>
<p>后续kube-apiserver使用RBAC 对客户端(如kubelet、kube-proxy、Pod)请求进行授权<br>kube-apiserver 预定义了一些RBAC 使用的RoleBindings，如cluster-admin 将Group system:masters与Role cluster-admin绑定，该Role 授予了调用kube-apiserver所有API 的权限<br>O 指定了该证书的Group 为system:masters，kubectl使用该证书访问kube-apiserver时，由于证书被CA 签名，所以认证通过，同时由于证书用户组为经过预授权的system:masters，所以被授予访问所有API 的劝降<br>hosts 属性值为空列表</p>
<p>新建目录/apps/conf/kubectl/ssl 在目录中生成admin 证书和私钥：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`cfssl genc`</span><br></pre></td></tr></table></figure>
<h4 id="创建kubectl-kubeconfig-文件"><a href="#创建kubectl-kubeconfig-文件" class="headerlink" title="创建kubectl kubeconfig 文件"></a>创建kubectl kubeconfig 文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`kubectl config ``set``-cluster kubernetes   --certificate-authority=``/apps/conf/kubernetes/ssl/ca``.pem   --embed-certs=``true`   `--server=$&#123;KUBE_APISERVER&#125;``kubectl config ``set``-credentials admin   --client-certificate=``/apps/conf/kubectl/ssl/admin``.pem   --embed-certs=``true`   `--client-key=``/apps/conf/kubectl/ssl/admin-key``.pem   --token=$&#123;BOOTSTRAP_TOKEN&#125;``kubectl config ``set``-context kubernetes   --cluster=kubernetes   --user=admin``kubectl config `</span><br></pre></td></tr></table></figure>
<p>admin.pem证书O 字段值为system:masters，kube-apiserver 预定义的 RoleBinding cluster-admin 将 Group system:masters 与 Role cluster-admin 绑定，该 Role 授予了调用kube-apiserver 相关 API 的权限<br>生成的kubeconfig 被保存到 ~/.kube/config 文件</p>
<p>注意这里是配置连接信息的。如果发现连接不通可以到 ~/.kube/config 这里查看服务器配置是否都正确</p>
<h4 id="分发kubeconfig-文件"><a href="#分发kubeconfig-文件" class="headerlink" title="分发kubeconfig 文件"></a>分发kubeconfig 文件</h4><p>将~/.kube/config文件拷贝到运行kubectl命令的机器的~/.kube/目录下去。</p>
<h3 id="部署K8s-Master节点"><a href="#部署K8s-Master节点" class="headerlink" title="部署K8s Master节点"></a>部署K8s Master节点</h3><p>kubernetes master 节点包含的组件有：</p>
<p>kube-apiserver<br>kube-scheduler<br>kube-controller-manager</p>
<p>目前这3个组件需要部署到同一台机器上：（后面再部署高可用的master）</p>
<p>kube-scheduler、kube-controller-manager 和 kube-apiserver 三者的功能紧密相关；<br>同时只能有一个 kube-scheduler、kube-controller-manager 进程处于工作状态，如果运行多个，则需要通过选举产生一个 leader；</p>
<p>master 节点与node 节点上的Pods 通过Pod 网络通信，所以需要在master 节点上部署Flannel 网络。</p>
<h4 id="创建kubernetes-证书"><a href="#创建kubernetes-证书" class="headerlink" title="创建kubernetes 证书"></a>创建kubernetes 证书</h4><p>创建kubernetes 证书签名请求：</p>
<p>进入目录  /apps/conf/kubernetes/ssl</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`cat` `&gt; kubernetes-csr.json &lt;&lt;EOF`</span><br></pre></td></tr></table></figure>
<ul>
<li>如果 hosts 字段不为空则需要指定授权使用该证书的 <strong>IP 或域名列表</strong>，所以上面分别指定了当前部署的 master 节点主机 IP 以及apiserver 负载的内部域名</li>
<li>还需要添加 kube-apiserver 注册的名为 <code>kubernetes</code> 的服务 IP (Service Cluster IP)，一般是 kube-apiserver <code>--service-cluster-ip-range</code> 选项值指定的网段的<strong>第一个IP</strong></li>
</ul>
<h4 id="生成kubernetes-证书和私钥："><a href="#生成kubernetes-证书和私钥：" class="headerlink" title="生成kubernetes 证书和私钥："></a>生成kubernetes 证书和私钥：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`cfssl gencert -ca=``/app`</span><br></pre></td></tr></table></figure>
<h4 id="配置和启动kube-apiserver"><a href="#配置和启动kube-apiserver" class="headerlink" title="配置和启动kube-apiserver"></a>配置和启动kube-apiserver</h4><h4 id="创建kube-apiserver-使用的客户端token-文件"><a href="#创建kube-apiserver-使用的客户端token-文件" class="headerlink" title="创建kube-apiserver 使用的客户端token 文件"></a>创建kube-apiserver 使用的客户端token 文件</h4><p>kubelet 首次启动时向kube-apiserver 发送TLS Bootstrapping 请求，kube-apiserver 验证请求中的token 是否与它配置的token.csv 一致，如果一致则自动为kubelet 生成证书和密钥。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`cd` `/apps/conf/kubernetes/``cat` `&gt; token.csv &lt;&lt;EOF``$&#123;BOOTSTRAP_TOKEN&#125;,kubele`</span><br></pre></td></tr></table></figure>
<h4 id="创建kube-apiserver-的systemd-unit文件"><a href="#创建kube-apiserver-的systemd-unit文件" class="headerlink" title="创建kube-apiserver 的systemd unit文件"></a>创建kube-apiserver 的systemd unit文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">cd /apps/sh</span><br><span class="line">cat  &gt; kube-apiserver.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/apps/svr/k8s/bin/kube-apiserver \\</span><br><span class="line">  --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \\</span><br><span class="line">  --advertise-address=$&#123;NODE_IP&#125; \\</span><br><span class="line">  --bind-address=0.0.0.0 \\</span><br><span class="line">  --insecure-bind-address=$&#123;NODE_IP&#125; \\</span><br><span class="line">  --authorization-mode=Node,RBAC \\</span><br><span class="line">  --runtime-config=rbac.authorization.k8s.io/v1alpha1 \\</span><br><span class="line">  --kubelet-https=true \\</span><br><span class="line">  --enable-bootstrap-token-auth \\</span><br><span class="line">  --token-auth-file=/apps/conf/kubernetes/token.csv \\</span><br><span class="line">  --service-cluster-ip-range=$&#123;SERVICE_CIDR&#125; \\</span><br><span class="line">  --service-node-port-range=$&#123;NODE_PORT_RANGE&#125; \\</span><br><span class="line">  --tls-cert-file=/apps/conf/kubernetes/ssl/kubernetes.pem \\</span><br><span class="line">  --tls-private-key-file=/apps/conf/kubernetes/ssl/kubernetes-key.pem \\</span><br><span class="line">  --client-ca-file=/apps/conf/kubernetes/ssl/ca.pem \\</span><br><span class="line">  --service-account-key-file=/apps/conf/kubernetes/ssl/ca-key.pem \\</span><br><span class="line">  --etcd-cafile=/apps/conf/kubernetes/ssl/ca.pem \\</span><br><span class="line">  --etcd-certfile=/apps/conf/kubernetes/ssl/kubernetes.pem \\</span><br><span class="line">  --etcd-keyfile=/apps/conf/kubernetes/ssl/kubernetes-key.pem \\</span><br><span class="line">  --etcd-servers=$&#123;ETCD_ENDPOINTS&#125; \\</span><br><span class="line">  --enable-swagger-ui=true \\</span><br><span class="line">  --allow-privileged=true \\</span><br><span class="line">  --apiserver-count=2 \\</span><br><span class="line">  --audit-log-maxage=30 \\</span><br><span class="line">  --audit-log-maxbackup=3 \\</span><br><span class="line">  --audit-log-maxsize=100 \\</span><br><span class="line">  --audit-log-path=/apps/logs/kubernetes/audit.log \\</span><br><span class="line">  --audit-policy-file=/apps/conf/kubernetes/audit-policy.yaml \\</span><br><span class="line">  --event-ttl=1h \\</span><br><span class="line">  --logtostderr=true \\</span><br><span class="line">  --v=6</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">Type=notify</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>1.9.x</strong>版本的，一定要注意上面的参数<code>experimental-bootstrap-token-auth</code>，需要替换成<code>enable-bootstrap-token-auth</code>，因为这个参数在<strong>1.9.x</strong>里面已经废弃掉了</li>
<li>kube-apiserver 1.6 版本开始使用 etcd v3 API 和存储格式</li>
<li><code>--authorization-mode=RBAC</code> 指定在安全端口使用RBAC 授权模式，拒绝未通过授权的请求</li>
<li>kube-scheduler、kube-controller-manager 一般和 kube-apiserver 部署在同一台机器上，它们使用<strong>非安全端口</strong>和 kube-apiserver通信</li>
<li>kubelet、kube-proxy、kubectl 部署在其它 Node 节点上，如果通过<strong>安全端口</strong>访问 kube-apiserver，则必须先通过 TLS 证书认证，再通过 RBAC 授权</li>
<li>kube-proxy、kubectl 通过使用证书里指定相关的 User、Group 来达到通过 RBAC 授权的目的</li>
<li>如果使用了 kubelet TLS Boostrap 机制，则不能再指定 <code>--kubelet-certificate-authority</code>、<code>--kubelet-client-certificate</code> 和 <code>--kubelet-client-key</code> 选项，否则后续 kube-apiserver 校验 kubelet 证书时出现 ”x509: certificate signed by unknown authority“ 错误</li>
<li><code>--admission-control</code> 值必须包含 <code>ServiceAccount</code>，否则部署集群插件时会失败</li>
<li><code>--bind-address</code> 不能为 <code>127.0.0.1</code></li>
<li><code>--service-cluster-ip-range</code> 指定 Service Cluster IP 地址段，该地址段不能路由可达</li>
<li><code>--service-node-port-range=${NODE_PORT_RANGE}</code> 指定 NodePort 的端口范围</li>
<li>缺省情况下 kubernetes 对象保存在<code>etcd/registry</code> 路径下，可以通过 <code>--etcd-prefix</code> 参数进行调整</li>
<li>kube-apiserver 1.8版本后需要在<code>--authorization-mode</code>参数中添加<code>Node</code>，即：<code>--authorization-mode=Node,RBAC</code>，否则Node 节点无法注册</li>
<li>注意要开启审查日志功能，指定<code>--audit-log-path</code>参数是不够的，这只是指定了日志的路径，还需要指定一个审查日志策略文件：<code>--audit-policy-file</code>，我们也可以使用日志收集工具收集相关的日志进行分析</li>
</ul>
<p>新建文件 audit-policy.yaml</p>
<p>在目录/apps/conf/kubernetes</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`apiVersion: audit.k8s.io``/v1beta1` `# This is required.``kind: Policy``# Don&apos;t generate audit events for all requests in RequestReceived stage.``omitStages:``  ``- ``&quot;Requ`</span><br></pre></td></tr></table></figure>
<p>审查日志的相关配置可以查看文档了解：<a href="https://kubernetes.io/docs/tasks/debug-application-cluster/audit/" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/debug-application-cluster/audit/</a></p>
<h4 id="启动kube-apiserver"><a href="#启动kube-apiserver" class="headerlink" title="启动kube-apiserver"></a>启动kube-apiserver</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cp kube-apiserver.service /etc/systemd/system/</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-apiserver</span><br><span class="line">systemctl start kube-apiserver</span><br><span class="line">systemctl status kube-apiserver</span><br></pre></td></tr></table></figure>
<h4 id="配置和启动kube-controller-manager"><a href="#配置和启动kube-controller-manager" class="headerlink" title="配置和启动kube-controller-manager"></a>配置和启动kube-controller-manager</h4><h4 id="启动kube-controller-manager"><a href="#启动kube-controller-manager" class="headerlink" title="启动kube-controller-manager"></a>启动kube-controller-manager</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`cp` `kube-controller-manager.service ``/etc/systemd/system/``systemctl daemon-reload``systemctl ``enable` `kube-controller-manager``systemctl start kube-controller-manager  ``systemctl status kube-controller-manager`</span><br></pre></td></tr></table></figure>
<h4 id="配置和启动kube-scheduler"><a href="#配置和启动kube-scheduler" class="headerlink" title="配置和启动kube-scheduler"></a>配置和启动kube-scheduler</h4><h4 id="创建kube-scheduler-的systemd-unit文件"><a href="#创建kube-scheduler-的systemd-unit文件" class="headerlink" title="创建kube-scheduler 的systemd unit文件"></a>创建kube-scheduler 的systemd unit文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`cat` `&gt; kube-scheduler.service &lt;&lt;EOF``[Unit]``Description=Kubernetes Scheduler``Documentation=https:``//github``.com``/GoogleCloudPlatform/kubernetes``[Service]``ExecStart=``/apps/svr/k8s/bin/kube-scheduler` `\\``  ``--address=127.0.0.1 \\``  ``--master=http:``//``$&#123;MASTER_URL&#125;:8080 \\``  ``--leader-elect=``true` `\\``  ``--``v``=2``Restart=on-failure``RestartSec=5``[Install]``WantedBy=multi-user.target``EOF`</span><br></pre></td></tr></table></figure>
<ul>
<li><code>--address</code> 值必须为 <code>127.0.0.1</code>，因为当前 kube-apiserver 期望 scheduler 和 controller-manager 在同一台机器</li>
<li><code>--master=http://${MASTER_URL}:8080</code>：使用<code>http</code>(非安全端口)与 kube-apiserver 通信，需要下面的<code>haproxy</code>启动成功后才能去掉8080端口</li>
<li><code>--leader-elect=true</code> 部署多台机器组成的 master 集群时选举产生一处于工作状态的 <code>kube-controller-manager</code> 进程</li>
</ul>
<h3 id="启动kube-scheduler"><a href="#启动kube-scheduler" class="headerlink" title="启动kube-scheduler"></a>启动kube-scheduler</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`cp` `kube-scheduler.service ``/etc/systemd/system/``systemctl daemon-reload``systemctl ``enable` `kube-scheduler``systemctl start kube-scheduler``systemctl status kube-scheduler`</span><br></pre></td></tr></table></figure>
<h2 id="6-4-验证master-节点"><a href="#6-4-验证master-节点" class="headerlink" title="6.4 验证master 节点"></a>6.4 验证master 节点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`kubectl get componentstatuses`</span><br></pre></td></tr></table></figure>
<p>NAME STATUS MESSAGE ERROR<br>controller-manager Healthy ok<br>scheduler Healthy ok<br>etcd-1 Healthy {“health”: “true”}<br>etcd-2 Healthy {“health”: “true”}<br>etcd-0 Healthy {“health”: “true”}</p>
<h3 id="关于k8s-master节点高可用"><a href="#关于k8s-master节点高可用" class="headerlink" title="关于k8s master节点高可用"></a>关于k8s master节点高可用</h3><p>目前所谓的 Kubernetes HA 其实主要的就是 API Server 的 HA，master 上其他组件比如 controller-manager 等都是可以通过 Etcd 做选举；而 API Server 只是提供一个请求接收服务，所以对于 API Server 一般有两种方式做 HA；一种是对多个 API Server 做 vip，另一种使用 nginx 反向代理，本文采用 nginx 方式</p>
<p><strong>master 之间除 api server 以外其他组件通过 etcd 选举，api server 默认不作处理；在每个 node 上启动一个 nginx，每个 nginx 反向代理所有 api server，node 上 kubelet、kube-proxy 连接本地的 nginx 代理端口，当 nginx 发现无法连接后端时会自动踢掉出问题的 api server，从而实现 api server 的 HA</strong></p>
<p>实际上是通过keepalived + haproxy实现的，其中keepalived是提供一个VIP，通过VIP关联所有的Master节点；然后haproxy提供端口转发功能。由于VIP还是存在Master的机器上的，默认配置API Server的端口是6443，所以我们需要将另外一个端口关联到这个VIP上，一般用8443。</p>
<p><code>haproxy</code>的确可以代理我们的两个master 上的apiserver 了，但是还不是高可用的，如果master01 这个节点down 掉了，那么我们haproxy 就不能正常提供服务了。这里我们可以使用两种方法来实现高可用</p>
<h4 id="方式1：使用阿里云SLB"><a href="#方式1：使用阿里云SLB" class="headerlink" title="方式1：使用阿里云SLB"></a>方式1：使用阿里云SLB</h4><p>这种方式实际上是最省心的，在阿里云上建一个内网的SLB，将master01 与master02 添加到SLB 机器组中，转发80(http)和443(https)端口即可（注意下面的提示）</p>
<blockquote>
<p>注意：阿里云的负载均衡是四层TCP负责，不支持后端ECS实例既作为Real Server又作为客户端向所在的负载均衡实例发送请求。因为返回的数据包只在云服务器内部转发，不经过负载均衡，所以在后端ECS实例上去访问负载均衡的服务地址是不通的。什么意思？就是如果你要使用阿里云的SLB的话，那么你不能在<code>apiserver</code>节点上使用SLB（比如在apiserver 上安装kubectl，然后将apiserver的地址设置为SLB的负载地址使用），因为这样的话就可能造成回环了，所以简单的做法是另外用两个新的节点做<code>HA</code>实例，然后将这两个实例添加到<code>SLB</code> 机器组中。</p>
</blockquote>
<h4 id="方式2：使用keepalived"><a href="#方式2：使用keepalived" class="headerlink" title="方式2：使用keepalived"></a>方式2：使用keepalived</h4><p><code>KeepAlived</code> 是一个高可用方案，通过 VIP（即虚拟 IP）和心跳检测来实现高可用。其原理是存在一组（两台）服务器，分别赋予 Master、Backup 两个角色，默认情况下Master 会绑定VIP 到自己的网卡上，对外提供服务。Master、Backup 会在一定的时间间隔向对方发送心跳数据包来检测对方的状态，这个时间间隔一般为 2 秒钟，如果Backup 发现Master 宕机，那么Backup 会发送ARP 包到网关，把VIP 绑定到自己的网卡，此时Backup 对外提供服务，实现自动化的故障转移，当Master 恢复的时候会重新接管服务。非常类似于路由器中的虚拟路由器冗余协议（VRRP）</p>
<h3 id="k8s-Node节点安装flannel网络"><a href="#k8s-Node节点安装flannel网络" class="headerlink" title="k8s Node节点安装flannel网络"></a>k8s Node节点安装flannel网络</h3><p>kubernetes 要求集群内各节点能通过Pod 网段互联互通，下面我们来使用Flannel 在所有节点上创建互联互通的Pod 网段的步骤。</p>
<h4 id="创建TLS-密钥和证书-1"><a href="#创建TLS-密钥和证书-1" class="headerlink" title="创建TLS 密钥和证书"></a>创建TLS 密钥和证书</h4><p>etcd 集群启用了双向TLS 认证，所以需要为flanneld 指定与etcd 集群通信的CA 和密钥。</p>
<p>创建flanneld 证书签名请求：</p>
<p>新建目录/apps/conf/flanneld/ssl</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cat &gt; flanneld-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;flanneld&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>生成flanneld 证书和私钥：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`cfssl gencert -ca=``/apps/conf/kubernetes/ssl/ca``.pem   -ca-key=``/apps/conf/kubernetes/ssl/ca-key``.pem   -config=``/apps/conf/kubernetes/ssl/ca-config``.json   -profile=kubernetes flanneld-csr.json | cfssljson -bare flanneld`</span><br></pre></td></tr></table></figure>
<h4 id="向etcd-写入集群Pod-网段信息"><a href="#向etcd-写入集群Pod-网段信息" class="headerlink" title="向etcd 写入集群Pod 网段信息"></a>向etcd 写入集群Pod 网段信息</h4><p>该步骤只需在第一次部署Flannel 网络时执行，后续在其他节点上部署Flanneld 时无需再写入该信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`etcdctl   --endpoints=$&#123;ETCD_ENDPOINTS&#125;   --ca-``file``=``/apps/conf/kubernetes/ssl/ca``.pem   --cert-``file``=``/apps/conf/flanneld/ssl/flanneld``.pem   --key-``file``=``/apps/conf/flanneld/ssl/flanneld-key``.pem   ``set` `$&#123;FLANNEL_ETCD_PREFIX&#125;``/config` `&apos;&#123;&quot;Network&quot;:&quot;&apos;``$&#123;CLUSTER_CIDR&#125;``&apos;&quot;, &quot;SubnetLen&quot;: 24, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;&apos;`</span><br></pre></td></tr></table></figure>
<p>写入的 Pod 网段(${CLUSTER_CIDR}，10.200.0.0/16) 必须与<code>kube-controller-manager</code> 的 <code>--cluster-cidr</code> 选项值一致；</p>
<p>创建flanneld的systemd unit 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`cd` `/apps/sh``cat` `&gt; flanneld.service &lt;&lt; EOF``[Unit]``Description=Flanneld overlay address etcd agent``After=network.target``After=network-online.target``Wants=network-online.target``After=etcd.service``Before=docker.service``[Service]``Type=notify``ExecStart=``/apps/svr/k8s/bin/flanneld` `\\``  ``-etcd-cafile=``/apps/conf/kubernetes/ssl/ca``.pem \\``  ``-etcd-certfile=``/apps/conf/flanneld/ssl/flanneld``.pem \\``  ``-etcd-keyfile=``/apps/conf/flanneld/ssl/flanneld-key``.pem \\``  ``-etcd-endpoints=$&#123;ETCD_ENDPOINTS&#125; \\``  ``-etcd-prefix=$&#123;FLANNEL_ETCD_PREFIX&#125;``ExecStartPost=``/apps/svr/k8s/bin/mk-docker-opts``.sh -k DOCKER_NETWORK_OPTIONS -d ``/run/flannel/docker``Restart=on-failure``[Install]``WantedBy=multi-user.target``RequiredBy=docker.service``EOF`</span><br></pre></td></tr></table></figure>
<ul>
<li><code>mk-docker-opts.sh</code>脚本将分配给flanneld 的Pod 子网网段信息写入到<code>/run/flannel/docker</code> 文件中，后续docker 启动时使用这个文件中的参数值为 docker0 网桥</li>
<li>flanneld 使用系统缺省路由所在的接口和其他节点通信，对于有多个网络接口的机器(内网和公网)，可以用 <code>--iface</code> 选项值指定通信接口(上面的 systemd unit 文件没指定这个选项)</li>
</ul>
<h4 id="启动flanneld"><a href="#启动flanneld" class="headerlink" title="启动flanneld"></a>启动flanneld</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`cp` `flanneld.service ``/etc/systemd/system/``systemctl daemon-reload``systemctl ``enable` `flanneld``systemctl start flanneld`</span><br></pre></td></tr></table></figure>
<h4 id="检查flanneld-服务"><a href="#检查flanneld-服务" class="headerlink" title="检查flanneld 服务"></a>检查flanneld 服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`ifconfig` `flannel.1`</span><br></pre></td></tr></table></figure>
<h4 id="检查分配给各flanneld-的Pod-网段信息"><a href="#检查分配给各flanneld-的Pod-网段信息" class="headerlink" title="检查分配给各flanneld 的Pod 网段信息"></a>检查分配给各flanneld 的Pod 网段信息</h4><p>查看集群 Pod 网段(/16)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`etcdctl \`` ``--endpoints=$&#123;ETCD_ENDPOINTS&#125; \`` ``--ca-``file``=``/apps/conf/kubernetes/ssl/ca``.pem \`` ``--cert-``file``=``/apps/conf/flanneld/ssl/flanneld``.pem \`` ``--key-``file``=``/apps/conf/flanneld/ssl/flanneld-key``.pem \`` ``get $&#123;FLANNEL_ETCD_PREFIX&#125;``/config`</span><br></pre></td></tr></table></figure>
<p>{“Network”:”10.200.0.0/16”, “SubnetLen”: 24, “Backend”: {“Type”: “vxlan”}}</p>
<h3 id="部署-K8s-Node节点"><a href="#部署-K8s-Node节点" class="headerlink" title="部署 K8s Node节点"></a>部署 K8s Node节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="解决从k8s-gcr-io拉取镜像失败问题"><a href="#解决从k8s-gcr-io拉取镜像失败问题" class="headerlink" title="解决从k8s.gcr.io拉取镜像失败问题"></a>解决从k8s.gcr.io拉取镜像失败问题</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker pull mirrorgooglecontainers/kube-apiserver-amd64:v1.11.3</span><br><span class="line">docker pull mirrorgooglecontainers/kube-controller-manager-amd64:v1.11.3</span><br><span class="line">docker pull mirrorgooglecontainers/kube-scheduler-amd64:v1.11.3</span><br><span class="line">docker pull mirrorgooglecontainers/kube-proxy-amd64:v1.11.3</span><br><span class="line">docker pull mirrorgooglecontainers/pause:3.1</span><br><span class="line">docker pull mirrorgooglecontainers/etcd-amd64:3.2.18</span><br><span class="line">docker pull coredns/coredns:1.1.3</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker tag docker.io/mirrorgooglecontainers/kube-proxy-amd64:v1.11.3 k8s.gcr.io/kube-proxy-amd64:v1.11.3</span><br><span class="line">docker tag docker.io/mirrorgooglecontainers/kube-scheduler-amd64:v1.11.3 k8s.gcr.io/kube-scheduler-amd64:v1.11.3</span><br><span class="line">docker tag docker.io/mirrorgooglecontainers/kube-apiserver-amd64:v1.11.3 k8s.gcr.io/kube-apiserver-amd64:v1.11.3</span><br><span class="line">docker tag docker.io/mirrorgooglecontainers/kube-controller-manager-amd64:v1.11.3 k8s.gcr.io/kube-controller-manager-amd64:v1.11.3</span><br><span class="line">docker tag docker.io/mirrorgooglecontainers/etcd-amd64:3.2.18  k8s.gcr.io/etcd-amd64:3.2.18</span><br><span class="line">docker tag docker.io/mirrorgooglecontainers/pause:3.1  k8s.gcr.io/pause:3.1</span><br><span class="line">docker tag docker.io/coredns/coredns:1.1.3  k8s.gcr.io/coredns:1.1.3</span><br></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><blockquote>
<ul>
<li><a href="https://www.qikqiak.com/post/manual-install-high-available-kubernetes-cluster/" target="_blank" rel="noopener">https://www.qikqiak.com/post/manual-install-high-available-kubernetes-cluster/</a></li>
<li><a href="https://github.com/mendickxiao/kubeasz/blob/master/docs/00-%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E5%92%8C%E5%9F%BA%E7%A1%80%E5%8F%82%E6%95%B0%E8%AE%BE%E5%AE%9A.md" target="_blank" rel="noopener">https://github.com/mendickxiao/kubeasz/blob/master/docs/00-%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E5%92%8C%E5%9F%BA%E7%A1%80%E5%8F%82%E6%95%B0%E8%AE%BE%E5%AE%9A.md</a></li>
<li><a href="https://jimmysong.io/kubernetes-handbook/practice/master-ha.html" target="_blank" rel="noopener">https://jimmysong.io/kubernetes-handbook/practice/master-ha.html#</a></li>
<li><a href="https://www.kubernetes.org.cn/5025.html" target="_blank" rel="noopener">https://www.kubernetes.org.cn/5025.html</a></li>
<li><a href="https://www.kubernetes.org.cn/4963.html" target="_blank" rel="noopener">https://www.kubernetes.org.cn/4963.html</a></li>
<li><a href="https://k8s-install.opsnull.com/01.%E7%B3%BB%E7%BB%9F%E5%88%9D%E5%A7%8B%E5%8C%96%E5%92%8C%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F.html" target="_blank" rel="noopener">https://k8s-install.opsnull.com/01.%E7%B3%BB%E7%BB%9F%E5%88%9D%E5%A7%8B%E5%8C%96%E5%92%8C%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F.html</a></li>
<li><a href="https://kubernetes.feisky.xyz/bu-shu-pei-zhi/index" target="_blank" rel="noopener">https://kubernetes.feisky.xyz/bu-shu-pei-zhi/index</a></li>
<li><a href="https://mritd.me/2017/07/21/set-up-kubernetes-ha-cluster-by-binary/" target="_blank" rel="noopener">https://mritd.me/2017/07/21/set-up-kubernetes-ha-cluster-by-binary/</a></li>
</ul>
</blockquote>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2019-02-12T10:57:34.004Z" itemprop="dateUpdated">2019-02-12 18:57:34</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="https://yo42.github.io">
            <img src="/img/yo.jpg" alt="Yo">
            Yo
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            

            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://yo42.github.io/2019/01/29/搭建k8s集群/&title=《搭建k8s集群》 — Yo42&pic=https://yo42.github.io/img/yo.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://yo42.github.io/2019/01/29/搭建k8s集群/&title=《搭建k8s集群》 — Yo42&source=aaa" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://yo42.github.io/2019/01/29/搭建k8s集群/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《搭建k8s集群》 — Yo42&url=https://yo42.github.io/2019/01/29/搭建k8s集群/&via=https://yo42.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://yo42.github.io/2019/01/29/搭建k8s集群/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="waves-block waves-effect next">
      <a href="/2018/10/28/DevOps-SRE-必备技能清单/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">DevOps &amp; SRE 必备技能清单</h4>
      </a>
    </div>
  
</nav>



    

















</article>



</div>

        <footer class="footer">
    <div class="top">
        

        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>This blog is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Yo &copy; 2019</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> 
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://yo42.github.io/2019/01/29/搭建k8s集群/&title=《搭建k8s集群》 — Yo42&pic=https://yo42.github.io/img/yo.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://yo42.github.io/2019/01/29/搭建k8s集群/&title=《搭建k8s集群》 — Yo42&source=aaa" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://yo42.github.io/2019/01/29/搭建k8s集群/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《搭建k8s集群》 — Yo42&url=https://yo42.github.io/2019/01/29/搭建k8s集群/&via=https://yo42.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://yo42.github.io/2019/01/29/搭建k8s集群/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://yo42.github.io/2019/01/29/搭建k8s集群/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>










<script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>